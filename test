#!/bin/bash

# Colors
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
CYAN="\033[1;36m"
RESET="\033[0m"

echo -e "${CYAN}Instructions:${RESET}"
echo -e "  - Press ${GREEN}Enter${RESET} to go into a folder"
echo -e "  - Press ${GREEN}c${RESET} to copy the selected folder/file"
echo ""
echo -n "Connecting"

for i in {1..6}; do
    sleep 0.2
    echo -n "."
done
echo ""

USER="akif"
HOST="172.17.17.108"
PASS="akif"
REMOTE_PATH="/home/$USER/Desktop"
echo -e "User: ${GREEN}$USER${RESET}  Host: ${GREEN}$HOST${RESET}"

# Spinner function for loading indicator
spin() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while kill -0 $pid 2>/dev/null; do
        for i in $(seq 0 3); do
            printf "\r[%c] Copying..." "${spinstr:i:1}"
            sleep $delay
        done
    done
    printf "\r${GREEN}[âœ“]${RESET} Done copying %s          \n" "$ITEM"
}

while true; do
    # List remote files/folders with type info
    
    LIST_OUTPUT=$(sshpass -p "$PASS" sftp -oBatchMode=no -oStrictHostKeyChecking=no "$USER@$HOST" <<EOF 2>/dev/null
cd "$REMOTE_PATH"
ls -l
bye
EOF
)

    # Clean SFTP output and extract type + name
    CLEAN_LIST=$(echo "$LIST_OUTPUT" | sed '/^sftp>/d;/^$/d;/^ls -l$/d' | awk '{name=$NF; type=substr($1,1,1); if(type=="d"){print name"/"} else {print name}}')

    # If directory is empty
    if [[ -z "$CLEAN_LIST" ]]; then
        echo "Directory empty or inaccessible: $REMOTE_PATH"
        read -p "Press Enter to go back..."
        REMOTE_PATH=$(dirname "$REMOTE_PATH")
        [[ "$REMOTE_PATH" == "." ]] && REMOTE_PATH="/"
        continue
    fi

    # Show fzf menu
    SELECTION=$(echo "$CLEAN_LIST" | fzf --prompt="$REMOTE_PATH> " --expect=enter,c --height=20 --border)
    [[ -z "$SELECTION" ]] && break

    KEY=$(echo "$SELECTION" | head -n1)
    ITEM=$(echo "$SELECTION" | tail -n1 | sed 's:/$::')
    [[ -z "$ITEM" ]] && continue

    if [[ "$KEY" == "c" ]]; then
        echo "Copying: $REMOTE_PATH/$ITEM to local..."
        sshpass -p "$PASS" scp -r -P 22 "$USER@$HOST:$REMOTE_PATH/$ITEM" ./ &
        scp_pid=$!
        spin $scp_pid
        wait $scp_pid
        break
    elif [[ "$KEY" == "enter" ]]; then
        # Check if it was a directory (ends with / in CLEAN_LIST)
        if echo "$CLEAN_LIST" | grep -q "^$ITEM/$"; then
            REMOTE_PATH="$REMOTE_PATH/$ITEM"
        else
            echo "Please press c to copy this file"
            clear
            echo -e "${CYAN}Instructions:${RESET}"
            echo -e "  - Press ${GREEN}Enter${RESET} to go into a folder"
            echo -e "  - Press ${GREEN}c${RESET} to copy the selected folder/file"
            echo ""
            echo -e "User: ${GREEN}$USER${RESET}  Host: ${GREEN}$HOST${RESET}"
            echo ""
            echo "Please press c to copy this file"
            
        fi
    else
        break
    fi
done